# ~/.tmux.conf

unbind C-b
set -g prefix `
bind ` send-prefix

set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on
set -g repeat-time 1000
set -g history-limit 10000

# Fix terminal color query issues
set -g allow-passthrough off
set -g set-clipboard off

bind v split-window -v -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind h split-window -h -c "#{pane_current_path}"
bind | split-window -h -c "#{pane_current_path}"
bind f resize-pane -Z

# Smart pane navigation with vim-like bindings
bind -n C-h select-pane -L
bind -n C-j select-pane -D
bind -n C-k select-pane -U
bind -n C-l select-pane -R

# Pane resizing with arrow keys
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Quick window switching
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5

# Synchronize panes toggle
bind S setw synchronize-panes \; display-message "Synchronize panes: #{?pane_synchronized,ON,OFF}"

# Note: Shell aliases should be in ~/.bashrc or ~/.zshrc, not tmux.conf
# alias tn='tmux new-session -s'
# alias ta='tmux attach-session'
# alias tl='tmux list-sessions'

bind -N "last-session (via sesh) " L run-shell "sesh last"

bind-key "T" run-shell "sesh connect \"\$(
  sesh list --icons | fzf-tmux -p 80%,70% \
    --no-sort --ansi --border-label ' sesh ' --prompt '‚ö°  ' \
    --header '  ^a all ^t tmux ^g configs ^x zoxide ^d tmux kill ^f find' \
    --bind 'tab:down,btab:up' \
    --bind 'ctrl-a:change-prompt(‚ö°  )+reload(sesh list --icons)' \
    --bind 'ctrl-t:change-prompt(ü™ü  )+reload(sesh list -t --icons)' \
    --bind 'ctrl-g:change-prompt(‚öôÔ∏è  )+reload(sesh list -c --icons)' \
    --bind 'ctrl-x:change-prompt(üìÅ  )+reload(sesh list -z --icons)' \
    --bind 'ctrl-f:change-prompt(üîé  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
    --bind 'ctrl-d:execute(tmux kill-session -t {2..})+change-prompt(‚ö°  )+reload(sesh list --icons)' \
    --preview-window 'right:55%' \
    --preview 'sesh preview {}'
)\""

bind-key x kill-pane # skip "kill-pane 1? (y/n)" prompt
set -g detach-on-destroy off  # don't exit from tmux when closing a session

setw -g mode-keys vi

# Copy mode keybindings
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send-keys -X cancel
bind -T copy-mode-vi H send-keys -X start-of-line
bind -T copy-mode-vi L send-keys -X end-of-line

# Copy to system clipboard (Linux/WSL)
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'

# Options to make tmux more pleasant
set -g mouse on
set -g default-terminal "tmux-256color"

# Status bar position
set-option -g status-position bottom
set -g escape-time 0

# Enhanced pane styling with Catppuccin colors
set -g pane-border-style "fg=#{@thm_surface_0}"
set -g pane-active-border-style "fg=#{@thm_lavender},bg=default"
set -g pane-border-lines heavy
set -g pane-border-format " #{?pane_active,#[fg=#{@thm_peach}] ,}#{pane_index} #{pane_current_command} "
set -g pane-border-status top
# Configure the catppuccin plugin
set -g @catppuccin_flavor "mocha"
set -g @catppuccin_window_status_style "rounded"

# Window configuration with icons
set -g @catppuccin_window_current_text " #W"
set -g @catppuccin_window_text " #W"
set -g @catppuccin_window_default_fill "number"
set -g @catppuccin_window_current_fill "number"

# Automatic window naming based on current directory
set-option -g status-interval 2
set-option -g automatic-rename on
# Show directory name when in bash, or "command:directory" for other programs
set-option -g automatic-rename-format '#{?#{==:#{pane_current_command},bash},#{b:pane_current_path},#{pane_current_command}:#{b:pane_current_path}}'

# Configure Catppuccin modules
set -g @catppuccin_status_modules_right "application session"
set -g @catppuccin_status_modules_left ""
set -g @catppuccin_status_connect_separator "yes"
set -g @catppuccin_status_fill "icon"

# Date time module configuration
set -g @catppuccin_date_time_text "%a %b %d  %I:%M %p"
set -g @catppuccin_date_time_icon ""
set -g @catppuccin_date_time_color "#{@thm_blue}"

# Directory module configuration  
set -g @catppuccin_directory_text "#{b:pane_current_path}"
set -g @catppuccin_directory_icon ""
set -g @catppuccin_directory_color "#{@thm_pink}"

# Session module configuration
set -g @catppuccin_session_icon ""
set -g @catppuccin_session_color "#{@thm_green}"

# CPU module configuration
set -g @catppuccin_cpu_icon ""
set -g @catppuccin_cpu_color "#{@thm_yellow}"

# Battery module configuration
set -g @catppuccin_battery_icon ""
set -g @catppuccin_battery_color "#{@thm_peach}"

# Override kube module to use absolute path (must be before loading catppuccin)
set -g @catppuccin_kube_text " #($HOME/.config/tmux/plugins/kube-tmux/kube.tmux)"

# Load catppuccin
run ~/.config/tmux/plugins/catppuccin/tmux/catppuccin.tmux

# Load custom status modules
run-shell 'tmux source-file ~/.config/tmux/status/memory.conf'
run-shell 'tmux source-file ~/.config/tmux/status/network.conf'
run-shell 'tmux source-file ~/.config/tmux/status/disk.conf'

# Enhanced status line configuration
set -g status-right-length 150
set -g status-left-length 100
set -g status-interval 1

# Left side: Session info with icon
set -g status-left ""
set -ag status-left "#{E:@catppuccin_status_session}"
set -ag status-left "#{E:@catppuccin_status_directory}"

# Right side: System info
set -g status-right "#{tmux_mode_indicator} "
set -ag status-right "#{E:@catppuccin_status_application}"
set -ag status-right "#{E:@catppuccin_status_gitmux}"
set -agF status-right "#{E:@catppuccin_status_kube}"

run ~/.config/tmux/plugins/tmux-cpu/cpu.tmux
run ~/.config/tmux/plugins/tmux-battery/battery.tmux
# Or, if using TPM, just run TPM


# Set TPM environment variable
set-environment -g TMUX_PLUGIN_MANAGER_PATH '~/.config/tmux/plugins/'

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-copycat'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'MunifTanjim/tmux-mode-indicator'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'jonmosco/kube-tmux'
set -g @plugin 'b0o/tmux-autoreload'

# Configuration for tmux-autoreload
set -g @tmux-autoreload-configs '~/.config/tmux/tmux.conf'
set -g @tmux-autoreload-quiet 1

# Configuration for tmux-mode-indicator
set -g @mode_indicator_prefix_prompt ' WAIT '
set -g @mode_indicator_prefix_mode_style 'bg=blue,fg=black'
set -g @mode_indicator_copy_prompt ' COPY '
set -g @mode_indicator_copy_mode_style 'bg=yellow,fg=black'
set -g @mode_indicator_sync_prompt ' SYNC '
set -g @mode_indicator_sync_mode_style 'bg=red,fg=black'
set -g @mode_indicator_empty_prompt ' TMUX '
set -g @mode_indicator_empty_mode_style 'bg=cyan,fg=black'

# Configuration for tmux-fzf
set -g @tmux-fzf-launch-key 'F'
# Add fzf to PATH for tmux-fzf
set-environment -g PATH "$HOME/.fzf/bin:$PATH"

# Claude popup windows
bind C display-popup -E -w 80% -h 80% "claude"
bind R display-popup -E -w 80% -h 80% "claude --continue"

# Generic popup for running commands with padding
bind p command-prompt -p "Command:" "display-popup -E -w 90% -h 90% '%%'"

# Other examples:
# set -g @plugin 'github_username/plugin_name'
# set -g @plugin 'github_username/plugin_name#branch'
# set -g @plugin 'git@github.com:user/plugin'
# set -g @plugin 'git@bitbucket.com:user/plugin'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'



# Use a working shell for new windows and panes
set -g default-shell /bin/bash
set -g default-command '/bin/bash --norc --noprofile -i'
